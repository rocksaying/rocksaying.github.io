---
title: PHP~~Photo163相冊圖檔網址計算器
category: programming
old-category: PHP
tags: []
---
<p>
Photo163 相冊圖檔網址計算器。把圖檔的網址解析出來後列表，將網址複製後，再交給下載工具如 Flashget 就 OK。程式是用 PHP 寫的，有用到 curl 。其實用 JavaScript 寫也可以，改天再出 JavaScript 的。
</p>

<!--more-->
<pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Type"</span> <span class="na">content=</span><span class="s">"text/html; charset=big5"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;</span>Photo163圖檔網址計算器<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"args"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
<span class="nt">&lt;fieldset&gt;</span>
<span class="nt">&lt;label&gt;</span>
Photo163 相簿中任何一張縮圖的圖片網址，可輸入多個不同相簿的縮圖網址:<span class="nt">&lt;br/&gt;</span>
<span class="err">&lt;</span>
<span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="s1">'textarea rows="10" cols="80" name="photo163url" id="photo163url"&gt;'</span><span class="p">;</span>
<span class="k">echo</span> <span class="s1">'&lt;/textarea'</span><span class="p">;</span>
<span class="cp">?&gt;</span>
&gt;
<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;br/&gt;</span>
<span class="nt">&lt;label&gt;</span>
密碼 (可不填):
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"password"</span> <span class="na">size=</span><span class="s">"40"</span> <span class="na">maxlength=</span><span class="s">"256"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"submit"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"reset"</span> <span class="na">name=</span><span class="s">"reset"</span> <span class="na">id=</span><span class="s">"reset"</span> <span class="na">value=</span><span class="s">"reset"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/fieldset&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">GetCurlPage</span> <span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="k">FALSE</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="c1">//curl_setopt($ch,    CURLOPT_VERBOSE, 1); ########### debug
</span>	<span class="c1">//curl_setopt($ch, CURLOPT_USERAGENT, $agent);
</span>	<span class="c1">//curl_setopt ($ch,    CURLOPT_HTTPHEADER, $header);
</span>	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_FOLLOWLOCATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_COOKIEJAR</span><span class="p">,</span> <span class="s2">"curl_cookie"</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_COOKIEFILE</span><span class="p">,</span> <span class="s2">"curl_cookie"</span><span class="p">);</span>
	<span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">curl_exec</span> <span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nb">curl_errno</span><span class="p">(</span><span class="nv">$ch</span><span class="p">))</span> <span class="nv">$tmp</span><span class="o">=</span><span class="nb">curl_error</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
	<span class="nb">curl_close</span> <span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">$tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">PostCurlPage</span> <span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="k">FALSE</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
	<span class="c1">//curl_setopt($ch,    CURLOPT_VERBOSE, 1); ########### debug
</span>	<span class="c1">//curl_setopt($ch,    CURLOPT_USERAGENT, $agent);
</span>	<span class="c1">//curl_setopt($ch,    CURLOPT_HTTPHEADER, $header);
</span>	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_FOLLOWLOCATION</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_COOKIEJAR</span><span class="p">,</span> <span class="s2">"curl_cookie"</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_COOKIEFILE</span><span class="p">,</span> <span class="s2">"curl_cookie"</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_POST</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_POSTFIELDS</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
<span class="cm">/*
To make a POST in multipart/form-data mode
(to upload a file for example) you can use

curl_setopt($ch,CURLOPT_POSTFIELDS,$postdata);

where $postdata is an array :
$post['key1'] = 'data1'
//  like a text field in a POST

$post['file1'] = '@filename1'
// upload filename1

For more informations see the
curl_formparse man page.
*/</span>

	<span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">curl_exec</span> <span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nb">curl_errno</span><span class="p">(</span><span class="nv">$ch</span><span class="p">))</span> <span class="nv">$tmp</span><span class="o">=</span><span class="nb">curl_error</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
	<span class="nb">curl_close</span> <span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">$tmp</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]))</span> <span class="p">{</span>
	<span class="c1">//echo "not yeat&lt;br/&gt;";
</span>	<span class="c1">//$photo163_page = PostCurlPage("http://photo163.com", "");
</span><span class="p">}</span>

<span class="c1">//print_r($_POST);
//echo "&lt;hr/&gt;";
</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'photo163url'</span><span class="p">]))</span> <span class="p">{</span>
	<span class="nv">$url_set</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'photo163url'</span><span class="p">]));</span>
	<span class="k">foreach</span><span class="p">(</span><span class="nv">$url_set</span> <span class="k">as</span> <span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$url</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">"/\s|,/"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
		<span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/^http:\/\/([^\/]+)\/([^\/]+)\/(\d+)\/.+\.jpg$/i"</span><span class="p">,</span> <span class="nv">$url</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
		<span class="c1">//print_r($matches);
</span>		<span class="nv">$userid</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="nv">$photoid</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="nv">$img_base_url</span> <span class="o">=</span> <span class="s2">"http://</span><span class="si">{</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span><span class="o">/</span><span class="s2">";
		unset(</span><span class="nv">$matches</span><span class="s2">);

		</span><span class="nv">$photosinfo_url</span><span class="s2"> = "</span><span class="nx">http</span><span class="o">://</span><span class="nx">photo</span><span class="o">.</span><span class="mf">163.</span><span class="nx">com</span><span class="o">/</span><span class="nx">js</span><span class="o">/</span><span class="nx">photosinfo</span><span class="o">.</span><span class="nx">php</span><span class="o">?</span><span class="nx">user</span><span class="o">=</span><span class="p">{</span><span class="nv">$userid</span><span class="si">}</span><span class="s2">&amp;aid=</span><span class="si">{</span><span class="nv">$photoid</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
		<span class="nv">$page</span> <span class="o">=</span> <span class="nx">GetCurlPage</span><span class="p">(</span><span class="nv">$photosinfo_url</span><span class="p">);</span>
		<span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/gPhotosIds = \[([\d|,]+)\]/"</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
		<span class="c1">//print_r($matches);
</span>		<span class="nv">$photo_set</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="nb">unset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">);</span>

		<span class="k">echo</span> <span class="s2">"&lt;hr/&gt;&lt;p&gt;The images of </span><span class="si">{</span><span class="nv">$userid</span><span class="si">}</span><span class="s2">'s photo(</span><span class="si">{</span><span class="nv">$photoid</span><span class="si">}</span><span class="s2">):&lt;/p&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
		<span class="nv">$n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">foreach</span><span class="p">(</span><span class="nv">$photo_set</span> <span class="k">as</span> <span class="nv">$photoname</span><span class="p">)</span> <span class="p">{</span>
		  <span class="k">echo</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$img_base_url</span><span class="si">}{</span><span class="nv">$userid</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$photoid</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$photoname</span><span class="si">}</span><span class="s2">.jpg&lt;br/&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
		  <span class="nv">$n</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">echo</span> <span class="s2">"&lt;p&gt;Total </span><span class="si">{</span><span class="nv">$n</span><span class="si">}</span><span class="s2"> of images&lt;/p&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>

<h6>相關文章</h6>
<ul>
<li><a href="{{ site.baseurl }}/archives/2006/Photo163%20%E7%9B%B8%E5%86%8A%E4%B8%8B%E8%BC%89%E5%B7%A5%E5%85%B7%20%28PHP%20%2B%20JavaScript%20%E5%AF%A6%E4%BD%9C%E7%89%88%E6%9C%AC%29.html">Photo163 相冊下載工具 (PHP   JavaScript 實作版本)</a></li>
</ul>
<div class="note">樂多舊網址: <a href="http://blog.roodo.com/rocksaying/archives/1327234.html">http://blog.roodo.com/rocksaying/archives/1327234.html</a></div>