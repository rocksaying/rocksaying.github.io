---
title: SQL~~一個較複雜的表格聯結 (join) 範例
category: programming
old-category: SQL/Database
tags: []
---
<p>在這個 table join 範例中，使用了 inner join, cross join, full outer join, 以 AS 將 sub-select 視為 table 再 join ，以及 group, case 等用法。這個範例雖然很長，<strong>但只是一句 SQL 查詢</strong>。拆開來是跑不出結果的。
</p>
<p>
此範例實際上取自我為了我任職的公司所寫的一個進銷存報表程式。我目前任職的公司，採用國內 飛X 公司所設計的零售業進銷存 POS 系統。這個範例中的表格及欄位名稱，直接對應該 POS 系統。另外，我是用 PHP 寫這隻報表程式，所以範例中嵌有 PHP 的變數名稱。此報表程式係依據進貨表格 (pos204) 、銷貨表格 (pos324) 及庫存表格 (product_stock) 中的貨品數量，計算出本期的期末庫存。表格 produt_stock 是我新增的，原先飛X 設計的 POS 系統中，並沒有這個表格。
</p>

<!--more-->
<pre class="highlight"><code><span class="k">select</span> 
	<span class="k">case</span> <span class="k">when</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">shop</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="n">tSale_qty</span><span class="p">.</span><span class="n">shop</span> <span class="k">else</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">shop</span> <span class="k">end</span> <span class="k">as</span> <span class="n">shop</span><span class="p">,</span> 
	<span class="k">case</span> <span class="k">when</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">prod</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="n">tSale_qty</span><span class="p">.</span><span class="n">prod</span> <span class="k">else</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">prod</span> <span class="k">end</span> <span class="k">as</span> <span class="n">prod</span><span class="p">,</span> 
	<span class="n">pos110</span><span class="p">.</span><span class="n">pname</span><span class="p">,</span> <span class="n">pos110</span><span class="p">.</span><span class="n">pluno</span><span class="p">,</span> <span class="n">pos116</span><span class="p">.</span><span class="n">lprc</span><span class="p">,</span>
	<span class="k">case</span> <span class="k">when</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">stock_qty</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">stock_qty</span> <span class="k">end</span> <span class="k">as</span> <span class="n">pre_stock_qty</span><span class="p">,</span>
	<span class="k">case</span> <span class="k">when</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">in_qty</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">in_qty</span> <span class="k">end</span> <span class="k">as</span> <span class="n">in_qty</span><span class="p">,</span>
	<span class="k">case</span> <span class="k">when</span> <span class="n">tSale_qty</span><span class="p">.</span><span class="n">sale_qty</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">tSale_qty</span><span class="p">.</span><span class="n">sale_qty</span> <span class="k">end</span> <span class="k">as</span> <span class="n">sale_qty</span><span class="p">,</span>
	<span class="k">case</span> 
	<span class="k">when</span> <span class="n">tSale_qty</span><span class="p">.</span><span class="n">sale_qty</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="p">(</span><span class="n">tStock_In</span><span class="p">.</span><span class="n">stock_qty</span> <span class="o">+</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">in_qty</span><span class="p">)</span> 
	<span class="k">when</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">stock_qty</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">and</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">in_qty</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="o">-</span><span class="n">tSale_qty</span><span class="p">.</span><span class="n">sale_qty</span>
	<span class="k">else</span> <span class="p">(</span><span class="n">tStock_In</span><span class="p">.</span><span class="n">stock_qty</span> <span class="o">+</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">in_qty</span> <span class="o">-</span> <span class="n">tSale_qty</span><span class="p">.</span><span class="n">sale_qty</span><span class="p">)</span> <span class="k">end</span> <span class="k">as</span> <span class="n">new_stock_qty</span>
<span class="k">from</span>
<span class="p">(</span>	<span class="k">select</span> 
		<span class="k">case</span> <span class="k">when</span> <span class="n">tStock_qty</span><span class="p">.</span><span class="n">shop</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="n">tInqty</span><span class="p">.</span><span class="n">shop</span> <span class="k">else</span> <span class="n">tStock_qty</span><span class="p">.</span><span class="n">shop</span> <span class="k">end</span> <span class="k">as</span> <span class="n">shop</span><span class="p">,</span> 
		<span class="k">case</span> <span class="k">when</span> <span class="n">tStock_qty</span><span class="p">.</span><span class="n">prod</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="n">tInqty</span><span class="p">.</span><span class="n">prod</span> <span class="k">else</span> <span class="n">tStock_qty</span><span class="p">.</span><span class="n">prod</span> <span class="k">end</span> <span class="k">as</span> <span class="n">prod</span><span class="p">,</span> 
		<span class="k">case</span> <span class="k">when</span> <span class="n">tStock_qty</span><span class="p">.</span><span class="n">stock_qty</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">tStock_qty</span><span class="p">.</span><span class="n">stock_qty</span> <span class="k">end</span> <span class="k">as</span> <span class="n">stock_qty</span><span class="p">,</span> 
		<span class="k">case</span> <span class="k">when</span> <span class="n">tInqty</span><span class="p">.</span><span class="n">in_qty</span> <span class="k">is</span> <span class="k">NULL</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">tInqty</span><span class="p">.</span><span class="n">in_qty</span> <span class="k">end</span> <span class="k">as</span> <span class="n">in_qty</span>
	<span class="k">from</span> <span class="p">(</span>
		<span class="k">select</span> <span class="n">product_stock</span><span class="p">.</span><span class="n">shop</span><span class="p">,</span> <span class="n">product_stock</span><span class="p">.</span><span class="n">prod</span><span class="p">,</span> <span class="n">product_stock</span><span class="p">.</span><span class="n">stock_qty</span> 
		<span class="k">from</span> <span class="n">product_stock</span> <span class="k">where</span> <span class="n">supp</span> <span class="o">=</span> <span class="s1">'{$supp}'</span> <span class="k">and</span> <span class="n">grade_date</span> <span class="o">=</span> <span class="s1">'{$grade_date}'</span> 
	<span class="p">)</span> <span class="k">as</span> <span class="n">tStock_qty</span>
	<span class="k">full</span> <span class="k">outer</span> <span class="k">join</span>
	<span class="p">(</span>	<span class="k">select</span> <span class="n">pos204</span><span class="p">.</span><span class="n">shop</span><span class="p">,</span> <span class="n">pos116</span><span class="p">.</span><span class="n">prod</span><span class="p">,</span> <span class="k">cast</span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="n">pos204</span><span class="p">.</span><span class="n">inqty</span><span class="p">)</span> <span class="k">as</span> <span class="n">integer</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_qty</span>
		<span class="k">from</span> <span class="n">pos116</span> 
		<span class="k">inner</span> <span class="k">join</span> <span class="n">pos204</span> 
		<span class="k">on</span> <span class="n">pos116</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="n">pos204</span><span class="p">.</span><span class="n">prod</span> <span class="k">and</span> <span class="n">pos204</span><span class="p">.</span><span class="n">indate</span> <span class="o">&gt;=</span> <span class="s1">'{$sdate}'</span> <span class="k">and</span> <span class="n">pos204</span><span class="p">.</span><span class="n">indate</span> <span class="o">&lt;=</span> <span class="s1">'{$edate}'</span> <span class="k">and</span> <span class="n">pos204</span><span class="p">.</span><span class="n">gctrl</span> <span class="o">=</span> <span class="s1">'4'</span>
		<span class="k">where</span> <span class="n">pos116</span><span class="p">.</span><span class="n">supp</span> <span class="o">=</span> <span class="s1">'{$supp}'</span> <span class="k">and</span> <span class="n">pos116</span><span class="p">.</span><span class="n">ano</span> <span class="o">=</span> <span class="s1">'{$ano}'</span>
		<span class="k">group</span> <span class="k">by</span> <span class="n">pos204</span><span class="p">.</span><span class="n">shop</span><span class="p">,</span> <span class="n">pos116</span><span class="p">.</span><span class="n">prod</span> 
	<span class="p">)</span> <span class="k">as</span> <span class="n">tInqty</span>
	<span class="k">on</span> <span class="n">tStock_qty</span><span class="p">.</span><span class="n">shop</span> <span class="o">=</span> <span class="n">tInqty</span><span class="p">.</span><span class="n">shop</span> <span class="k">and</span> <span class="n">tStock_qty</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="n">tInqty</span><span class="p">.</span><span class="n">prod</span> 
<span class="p">)</span> <span class="k">as</span> <span class="n">tStock_In</span>
<span class="k">full</span> <span class="k">outer</span> <span class="k">join</span> 
<span class="p">(</span>	<span class="k">select</span> <span class="n">pos324</span><span class="p">.</span><span class="n">shop</span><span class="p">,</span> <span class="n">pos324</span><span class="p">.</span><span class="n">prod</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">pos324</span><span class="p">.</span><span class="n">qty</span><span class="p">)</span> <span class="k">as</span> <span class="n">sale_qty</span>
	<span class="k">from</span> <span class="n">pos324</span>
	<span class="k">inner</span> <span class="k">join</span> <span class="n">pos116</span> 
	<span class="k">on</span> <span class="n">pos324</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="n">pos116</span><span class="p">.</span><span class="n">prod</span> <span class="k">and</span> <span class="n">pos116</span><span class="p">.</span><span class="n">ano</span> <span class="o">=</span> <span class="s1">'{$ano}'</span> <span class="k">and</span> <span class="n">pos116</span><span class="p">.</span><span class="n">supp</span> <span class="o">=</span> <span class="s1">'{$supp}'</span>
	<span class="k">where</span> <span class="n">pos324</span><span class="p">.</span><span class="n">ecrdate</span> <span class="o">&gt;=</span> <span class="s1">'{$sdate}'</span> <span class="k">and</span> <span class="n">pos324</span><span class="p">.</span><span class="n">ecrdate</span> <span class="o">&lt;=</span> <span class="s1">'{$edate}'</span>
	<span class="k">group</span> <span class="k">by</span> <span class="n">pos324</span><span class="p">.</span><span class="n">shop</span><span class="p">,</span> <span class="n">pos324</span><span class="p">.</span><span class="n">prod</span> 
<span class="p">)</span> <span class="k">as</span> <span class="n">tSale_qty</span>
<span class="k">on</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">shop</span> <span class="o">=</span> <span class="n">tSale_qty</span><span class="p">.</span><span class="n">shop</span> <span class="k">and</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="n">tSale_qty</span><span class="p">.</span><span class="n">prod</span>
<span class="k">inner</span> <span class="k">join</span> <span class="p">(</span><span class="n">pos110</span> 
	<span class="k">inner</span> <span class="k">join</span> <span class="n">pos116</span> 
	<span class="k">on</span> <span class="n">pos110</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="n">pos116</span><span class="p">.</span><span class="n">prod</span> <span class="k">and</span> <span class="n">pos116</span><span class="p">.</span><span class="n">ano</span> <span class="o">=</span> <span class="s1">'{$ano}'</span> <span class="k">and</span> <span class="n">pos116</span><span class="p">.</span><span class="n">supp</span> <span class="o">=</span> <span class="s1">'{$supp}'</span><span class="p">)</span> 
<span class="k">on</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="n">pos116</span><span class="p">.</span><span class="n">prod</span> <span class="k">or</span> <span class="n">tSale_qty</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="n">pos116</span><span class="p">.</span><span class="n">prod</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">shop</span><span class="p">,</span> <span class="n">tStock_In</span><span class="p">.</span><span class="n">prod</span><span class="p">;</span>
</code></pre>

<h6>相關文章</h6>
<ul>
<li><a href="{{ site.baseurl }}/archives/2006/SQL99%20%E4%B8%AD%E5%8F%96%E4%BB%A3%E5%AD%90%E6%9F%A5%E8%A9%A2%E8%A1%A8%E6%A0%BC%E7%9A%84%E5%8A%9F%E8%83%BD%20-%20CTE%20%28Common%20Table%20Expression%29.html">SQL99 中取代子查詢表格的功能 - CTE (Common Table Expression)</a></li>
</ul>
<div class="note">樂多舊網址: <a href="http://blog.roodo.com/rocksaying/archives/1186860.html">http://blog.roodo.com/rocksaying/archives/1186860.html</a></div>