---
title: TWPUG問答 - 如何偵測URL資源是否存在, Ajax way
category: programming
old-category: JavaScript
tags: [偵測url,ajax]
---
<div class="tags" style="display:none">Tags: 偵測URL ajax</div>
<p>
<a href="{{ site.baseurl }}/archives/2007/TWPUG%E5%95%8F%E7%AD%94%20-%20%E5%A6%82%E4%BD%95%E5%81%B5%E6%B8%ACURL%E8%B3%87%E6%BA%90%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8.html#comment-10349019">Ka-Yue</a> 說: <q>JavaScript have onerror event too</q>.
</p>
<p>
Good question. PHP 的偵測動作是在 server-side ，它可能增加 Server 不必要的網路負荷。如果改由 JavaScript 進行偵測動作，就可以把偵測動作分派給 client 去做。這是一種 Ajax 的應用。
</p>

<!--more-->
<p>
我將使用<code>img</code>網頁元件進行偵測動作。可先參考《<a href="{{ site.baseurl }}/archives/2006/Rendering%20images%20with%20title%20and%20box.html">Rendering images with title and box</a>》了解關於<code>img</code>的<code>onload</code> 與 <code>onerror</code> 的資訊。
</p>
<pre class="highlight"><code><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text/javascript"</span><span class="o">&gt;</span>
<span class="kd">function</span> <span class="nx">checkUri</span><span class="p">(</span><span class="nx">checkCase</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cmdMap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'success'</span><span class="p">:</span><span class="s1">'onload'</span><span class="p">,</span>
        <span class="s1">'error'</span><span class="p">:</span><span class="s1">'onerror'</span><span class="p">,</span>
        <span class="s1">'status'</span><span class="p">:</span><span class="s1">'status'</span><span class="p">,</span>
        <span class="s1">'uri'</span><span class="p">:</span><span class="s1">'src'</span>
    <span class="p">};</span>
    <span class="nx">uri</span><span class="p">.</span><span class="nx">$checkCase</span> <span class="o">=</span> <span class="nx">checkCase</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">cmdMap</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">uri</span><span class="p">[</span><span class="nx">cmdMap</span><span class="p">[</span><span class="nx">p</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">checkCase</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">successHandler</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$checkCase</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="s1">'200'</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">errorHandler</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$checkCase</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="s1">'404'</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">testCaseSet</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="na">uri</span><span class="p">:</span><span class="s1">'http://www.google.com.tw/intl/en_com/images/logo_plain.png'</span><span class="p">},</span>
    <span class="p">{</span><span class="na">uri</span><span class="p">:</span><span class="s1">'http://www.google.com.tw/intl/en_com/images/logo_plain.xxx'</span><span class="p">}</span>
<span class="p">];</span>

<span class="kd">var</span> <span class="nx">initProperties</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'success'</span><span class="p">:</span> <span class="nx">successHandler</span><span class="p">,</span>
    <span class="s1">'error'</span><span class="p">:</span> <span class="nx">errorHandler</span><span class="p">,</span>
    <span class="s1">'status'</span><span class="p">:</span> <span class="kc">null</span>
<span class="p">};</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">checkCase</span><span class="p">;</span> <span class="nx">checkCase</span><span class="o">=</span><span class="nx">testCaseSet</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">initProperties</span><span class="p">)</span>
        <span class="nx">checkCase</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">initProperties</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span>
    <span class="nx">checkUri</span><span class="p">(</span><span class="nx">checkCase</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">checkTimer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">checkOk</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">checkCase</span><span class="p">;</span> <span class="nx">checkCase</span><span class="o">=</span><span class="nx">testCaseSet</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">checkCase</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">checkOk</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">checkOk</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">checkTimer</span><span class="p">);</span>
            <span class="nx">report</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="mi">200</span>
<span class="p">);</span>

<span class="kd">function</span> <span class="nx">report</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'pre'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">checkCase</span><span class="p">;</span> <span class="nx">checkCase</span><span class="o">=</span><span class="nx">testCaseSet</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">msg</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
            <span class="nx">checkCase</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span>
            <span class="s1">': '</span> <span class="o">+</span>
            <span class="p">(</span><span class="nx">checkCase</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="s1">'200'</span> <span class="p">?</span> <span class="s1">'OK'</span> <span class="p">:</span> <span class="s1">'ERROR'</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'&lt;br/&gt;'</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">'body'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">&lt;</span><span class="sr">/script&gt;</span><span class="err">
</span><span class="o">&lt;</span><span class="sr">/body&gt;</span><span class="err">
</span><span class="o">&lt;</span><span class="sr">/html&gt;</span><span class="err">
</span></code></pre>

<p>
透過 JavaScript 在 Client 進行偵測動作時，是以非同步模式運行。故程式架構會比 PHP 的同步偵測模式複雜，但效率比同步模式快上許多。
</p>
<p>
上面的例子只是精簡版。我以前寫過 Ajax 版的無效連結偵測程式[可指定並行工作線程數(threads)]，輸入一個網址及指定的偵測層數後，可以從首頁往子網頁深入偵測無效連結。輸入同一個網址及同樣的探索層數， Ajax版比 PHP 版快上3-10倍有餘 (視使用者在 Ajax 版指定的並行偵測線程數而定)。
</p>
<p>
這個精簡的範例因為使用 <code>img</code> 實作，故有個缺點：它會把整份文件下載回 client 。如果想同 PHP 版那般只取 HEAD ，則須改用<code>XmlHttpRequest</code> 實現。但此時將面臨 <code>XmlHttpRequest</code> 的相同來源安全限制策略 (Same Origin Policy) ，故僅能偵測相同來源下之URL是否存在，用途受限。
</p><div class="note">樂多舊網址: http://blog.roodo.com/rocksaying/archives/3216885.html</div>
<div class="roodo-comments"><hr/><h6>樂多舊回應</h6>
<blockquote class="roodo-comment">
<div class="roodo-comment-author">tsysir@yahoo.com.tw(TyroneYeh) (#comment-10881997)</div>
<div class="roodo-comment-date">Tue, 12 Jun 2007 06:44:31 +0800</div>
<div class="roodo-comment-text">請問怎麼改成 function 化，代入網址來檢查是否存在，因為 testCaseSet 陣列如果放二十幾以上就不會動了!<br/>謝謝<br/>	</div>
</blockquote>
<blockquote class="roodo-comment">
<div class="roodo-comment-author">未留名 (#comment-10882473)</div>
<div class="roodo-comment-date">Tue, 12 Jun 2007 09:06:02 +0800</div>
<div class="roodo-comment-text">你需要管理多線程作業。<br/><br/>請參考 <a href="http://blog.roodo.com/rocksaying/archives/2102451.html">下載工具 Part.4 Ajax多線程管理</a> 的示範程式 (該文最後一段)。<br/>	</div>
</blockquote>
</div>
