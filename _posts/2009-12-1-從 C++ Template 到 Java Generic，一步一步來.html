---
title: 從 C++ Template 到 Java Generic，一步一步來
category: programming
old-category: C/C++/C#/Java
tags: [template, generic, 樣板, 泛型]
---
<p>
Java 實作了泛型(generic)機制以實現 C++ 樣板(template) 的一部份能力，兩者的語法乍看之下也有些相似。
雖然我覺得 <a href="{{ site.baseurl }}/archives/2006/C%2B%2B%20library%20%E7%9A%84%E7%99%BC%E5%B1%95%E5%9B%B0%E5%A2%83%2C%20part%202.html">C++ 樣板很難搞</a>，而且兩者的語法有點像，但是相較於完全陌生的 Java 泛型，我用起 C++ 樣板來還是比較熟練的。很自然的，當我試圖要用 Java 的泛型重構程式碼時，我會先從 C++ 樣板的觀點來思考。
</p>
<p>
我將日前工作中碰到的一段我想用泛型重構的程式碼，取其大綱出來練習。本文紀錄了大致的改寫過程。
</p>

<!--more-->
<h4>先用 C++ 樣板打草稿</h4>
<p>
我比較熟悉 C++ 樣板(template)，所以在動手使用 Java 泛型(generic)之前，我還是習慣先用 C++ 樣板來打稿，讓我構想程式結構。
</p>
<p>
有 N, M, S 三個類別，這三個類別沒有繼承關係。但是在操作形式上卻有相當高的重複性，很多地方只是型別不同，程式結構完全一樣。幾乎是剪貼、複製後，再代換型別名稱就完工的情形。正是泛型派得上用場的情形。樣板類別 Cx 就是重複的程式碼內容。
</p>

<pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
</span><span class="n">using</span> <span class="n">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="n">template</span><span class="o">&lt;</span><span class="n">class</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">class</span> <span class="n">ReturnType</span><span class="o">&gt;</span>
<span class="n">class</span> <span class="n">Cx</span> <span class="p">{</span>
  <span class="n">private</span><span class="o">:</span>
    <span class="n">DataType</span> <span class="n">data</span><span class="p">;</span>

  <span class="n">public</span><span class="o">:</span>
    <span class="n">Cx</span><span class="p">(</span><span class="n">DataType</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span> <span class="p">}</span>

    <span class="n">ReturnType</span> <span class="n">getData</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">class</span> <span class="n">N</span> <span class="p">{</span>
  <span class="n">private</span><span class="o">:</span>
    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

  <span class="n">public</span><span class="o">:</span>
    <span class="n">N</span><span class="p">()</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">N</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">int</span> <span class="n">value</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">n</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">class</span> <span class="n">M</span> <span class="p">{</span>
  <span class="n">private</span><span class="o">:</span>
    <span class="kt">int</span> <span class="n">m</span><span class="p">;</span>

  <span class="n">public</span><span class="o">:</span>
    <span class="n">M</span><span class="p">()</span> <span class="p">{</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">M</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="n">m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">int</span> <span class="n">value</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">class</span> <span class="n">S</span> <span class="p">{</span>
<span class="n">private</span><span class="o">:</span>
    <span class="n">string</span> <span class="n">s</span><span class="p">;</span>

<span class="n">public</span><span class="o">:</span>
    <span class="n">S</span><span class="p">()</span> <span class="p">{</span> <span class="n">s</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">S</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span> <span class="p">}</span>

    <span class="n">string</span> <span class="n">value</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">N</span> <span class="n">n</span> <span class="o">=</span> <span class="n">N</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">Cx</span><span class="o">&lt;</span><span class="n">N</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;*</span> <span class="n">cn</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">N</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">n</span> <span class="p">);</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">cn</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="n">M</span> <span class="n">m</span> <span class="o">=</span> <span class="n">M</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">Cx</span><span class="o">&lt;</span><span class="n">M</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;*</span> <span class="n">cm</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">M</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">m</span> <span class="p">);</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="n">S</span> <span class="n">s</span> <span class="o">=</span> <span class="n">S</span><span class="p">(</span><span class="s">"hello"</span><span class="p">);</span>
    <span class="n">Cx</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;*</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">s</span> <span class="p">);</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">getData</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>



<h4>Revision 1</h4>
<p>
第一步，先按 Java 的規則，將每個類別打散到個別的源碼文件中。
將 C++ 的類別定義語法改寫成 Java 的類別定義語法。將樣板(template)改成 Java 的泛型(generic)語法。
</p>

<h6>Cx.java</h6>
<pre class="highlight"><code><span class="c1">//revision: 1</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cx</span><span class="o">&lt;</span><span class="n">DataType</span><span class="o">,</span> <span class="n">ReturnType</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">DataType</span> <span class="n">data</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Cx</span><span class="o">(</span><span class="n">DataType</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">ReturnType</span> <span class="n">getData</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre>


<h6>N.java</h6>
<pre class="highlight"><code><span class="c1">//revision: 1</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">N</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">n</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">N</span><span class="o">()</span> <span class="o">{</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">N</span><span class="o">(</span><span class="kt">int</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span> <span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="n">value</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">n</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre>


<h6>M.java</h6>
<pre class="highlight"><code><span class="c1">//revision: 1</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">M</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">m</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">M</span><span class="o">()</span> <span class="o">{</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">M</span><span class="o">(</span><span class="kt">int</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span> <span class="n">m</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="n">value</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">10</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre>


<h6>S.java</h6>
<pre class="highlight"><code><span class="c1">//revision: 1</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">S</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">s</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">S</span><span class="o">()</span> <span class="o">{</span> <span class="n">s</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">S</span><span class="o">(</span><span class="n">String</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span> <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="n">value</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre>


<h6>Main.java</h6>
<pre class="highlight"><code><span class="c1">//revision: 1</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="n">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">N</span> <span class="n">n</span> <span class="o">=</span> <span class="k">new</span> <span class="n">N</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">Cx</span><span class="o">&lt;</span><span class="n">N</span><span class="o">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">cn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">N</span><span class="o">,</span> <span class="kt">int</span><span class="o">&gt;(</span> <span class="n">n</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">cn</span><span class="o">.</span><span class="na">getData</span><span class="o">()</span> <span class="o">);</span>

        <span class="n">M</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">M</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">Cx</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">cm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span> <span class="kt">int</span><span class="o">&gt;(</span> <span class="n">m</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">cm</span><span class="o">.</span><span class="na">getData</span><span class="o">()</span> <span class="o">);</span>

        <span class="n">S</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">S</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
        <span class="n">Cx</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;(</span> <span class="n">s</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">cs</span><span class="o">.</span><span class="na">getData</span><span class="o">()</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>


<p>
類別 N, M, S 編譯都沒問題，但是編譯 Cx 時 javac 告訴我不知道 <code>data.value</code>這個符號是什麼？
</p>

<pre class="highlight"><code>    <span class="kd">public</span> <span class="n">ReturnType</span> <span class="nf">getData</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
        <span class="c1">//error:   ^  cannot find symbol</span>
    <span class="o">}</span>
</code></pre>


<p>
這時，我才想到 Java 支援的是泛型而不是樣板，這兩者果然是不同的。
</p>
<p>
樣板基本上是把整個定義內容視為一個程式碼原型，編譯時再將參數中列出的類別符號，代換掉程式碼中的符號。我們可以把這個動作比擬為 script 對字串的竄寫動作。我用 PHP 來模擬示範。
</p>

<pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">//Cx&lt;N, int&gt;* cn = new Cx&lt;N, int&gt;( n );
</span><span class="nv">$DataType</span> <span class="o">=</span> <span class="s1">'N'</span><span class="p">;</span>
<span class="nv">$ReturnType</span> <span class="o">=</span> <span class="s1">'int'</span><span class="p">;</span>

<span class="c1">//template&lt;class DataType, class ReturnType&gt;
</span><span class="nv">$template_DataType_ReturnType</span> <span class="o">=&lt;&lt;&lt;</span><span class="nx">CX</span>
<span class="k">class</span> <span class="nc">Cx__</span><span class="err">$</span><span class="p">{</span><span class="nx">DataType</span><span class="p">}</span><span class="nx">__</span><span class="err">$</span><span class="p">{</span><span class="nx">ReturnType</span><span class="p">}</span> <span class="p">{</span> <span class="c1">//模擬 template 產生的新類別簽名
</span>  <span class="k">private</span><span class="o">:</span>
    <span class="err">$</span><span class="p">{</span><span class="nx">DataType</span><span class="p">}</span> <span class="nx">data</span><span class="p">;</span>

  <span class="k">public</span><span class="o">:</span>
    <span class="nx">Cx</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="nx">DataType</span><span class="p">}</span><span class="o">&amp;</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span> <span class="p">}</span>

    <span class="err">$</span><span class="p">{</span><span class="nx">ReturnType</span><span class="p">}</span> <span class="nx">getData</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">data</span><span class="o">.</span><span class="nx">value</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">CX</span><span class="p">;</span>

<span class="k">echo</span> <span class="nv">$template_DataType_ReturnType</span>
<span class="cp">?&gt;</span>
</code></pre>


<p>
輸出結果是一個新的類別的程式碼。
</p>

<pre class="highlight"><code><span class="n">class</span> <span class="n">Cx__N__int</span> <span class="p">{</span> <span class="c1">//模擬 template 產生的新類別簽名
</span>  <span class="nl">private:</span>
    <span class="n">N</span> <span class="n">data</span><span class="p">;</span>

  <span class="n">public</span><span class="o">:</span>
    <span class="n">Cx</span><span class="p">(</span><span class="n">N</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">int</span> <span class="n">getData</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre>


<p>
C++ 編譯器(或者是前置處理器)先將樣板內容進行如上所模擬的代換動作，產生新的類別程式碼，再將生成的程式碼交給一般程式碼編譯單元(或者是後端的 C compiler)編譯成目的碼(object code)。
</p>

<p>
但是 Java 提供的是泛型而不是樣板，所以它無法這麼簡單地完成型別參數的代換動作。
泛型只是告訴 javac ，我們會將類別當成參數傳遞過來，這些類別之間可能沒有繼承關係，但是卻共用一組一般化的程式碼進行演算。
再者，如果我們在一般化的程式碼中，要調用參數化型別之實體的方法，那麼我們也必須告訴 javac 一個一般化、泛型化的類別定義，這樣 javac 才會知道這個參數化型別大概長什麼樣子、有哪些方法。
</p>

<h4>Revision 2</h4>

<p>
在第一個修改版本中，我只告訴 javac: "data 的型別將會由 DataType 參數傳遞過來"。
但我沒有告訴它 <code>DataType</code> 大概長什麼樣子，所以它無從尋找 <code>data.value</code> 這個符號。
</p>
<p>
我們必須再定義一個東西，這個東西至少要有 <code>value()</code> 方法。
而我們要把這個東西當成 <code>DataType</code> 參數化型別的泛型、一般化內容。
這個東西只要有個輪廓，並不需要有任何實際的內容，用介面(interface) 或抽象類別(abstract class)都可。
</p>
<p>
我再加一個介面 <code>IDataType</code> 作為 <code>DataType</code> 的泛型吧。
</p>

<pre class="highlight"><code><span class="c1">//revision: 2</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IDataType</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">value</span><span class="o">();</span>
<span class="o">}</span>
</code></pre>

<br/>

<pre class="highlight"><code><span class="c1">//revision: 2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cx</span><span class="o">&lt;</span><span class="n">DataType</span> <span class="kd">extends</span> <span class="n">IDataType</span><span class="o">,</span> <span class="n">ReturnType</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">DataType</span> <span class="n">data</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Cx</span><span class="o">(</span><span class="n">DataType</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">ReturnType</span> <span class="n">getData</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
        <span class="c1">//error: incompatible types</span>
        <span class="c1">//found   : int</span>
        <span class="c1">//required: ReturnType</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre>



<h4>Revision 3</h4>

<p>
哎呀，我在宣告 <code>DataType</code> 時，沒有考慮到 <code>data.value</code> 用於 <code>DataType.getData()</code> 的回傳值，只是隨手寫了 <code>int</code> 作為 <code>IDataType.value()</code> 回傳型態。於是 javac 又說找到 <code>int</code> 但要的是 <code>ReturnType</code>，兩者型態不符合。
</p>

<p>
但是 <code>ReturnType</code> 是另一個參數化的型別，顯然我得把 <code>ReturnType</code> 這個參數再傳給 <code>IDataType</code> 才行。這就要把 <code>IDataType</code> 也變成另一個泛型，具有一個型別參數。
接著修改 Cx，把 Cx 泛型定義中的 <code>ReturnType</code> 再傳給 <code>IDataType&lt;?&gt;</code> 。
</p>

<pre class="highlight"><code><span class="c1">// revision: 3</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IDataType</span><span class="o">&lt;</span><span class="n">ReturnType</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">ReturnType</span> <span class="n">value</span><span class="o">();</span>
<span class="o">}</span>
</code></pre>

<br/>

<pre class="highlight"><code><span class="c1">// revision: 3</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cx</span><span class="o">&lt;</span><span class="n">DataType</span> <span class="kd">extends</span> <span class="n">IDataType</span><span class="o">&lt;</span><span class="n">ReturnType</span><span class="o">&gt;,</span> <span class="n">ReturnType</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">DataType</span> <span class="n">data</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Cx</span><span class="o">(</span><span class="n">DataType</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">ReturnType</span> <span class="n">getData</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre>


<p>
Ok, 這次 javac 沒再抱怨了，泛型的主要內容沒錯。接下來編譯 Main。
</p>

<pre class="highlight"><code><span class="c1">//revision: 1</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="n">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">N</span> <span class="n">n</span> <span class="o">=</span> <span class="k">new</span> <span class="n">N</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">Cx</span><span class="o">&lt;</span><span class="n">N</span><span class="o">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">cn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">N</span><span class="o">,</span> <span class="kt">int</span><span class="o">&gt;(</span> <span class="n">n</span> <span class="o">);</span>
        <span class="c1">//    ^  unexpected type</span>
        <span class="c1">//found   : int</span>
        <span class="c1">//required: reference</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">cn</span><span class="o">.</span><span class="na">getData</span><span class="o">()</span> <span class="o">);</span>

        <span class="n">M</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">M</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">Cx</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">cm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span> <span class="kt">int</span><span class="o">&gt;(</span> <span class="n">m</span> <span class="o">);</span>
        <span class="c1">//    ^  unexpected type</span>
        <span class="c1">//found   : int</span>
        <span class="c1">//required: reference</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">cm</span><span class="o">.</span><span class="na">getData</span><span class="o">()</span> <span class="o">);</span>

        <span class="n">S</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">S</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
        <span class="n">Cx</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;(</span> <span class="n">s</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">cs</span><span class="o">.</span><span class="na">getData</span><span class="o">()</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>

<p>
不接受 int 類別作為參數，但是接受 String 類別作為參數。
</p>

<h4>Revision 4</h4>
<p>
喔喔，我又忘了 Java 沒有把原始型態和參考型態一視同仁，泛型不支援原始型態。
所以原始型態的 int 要改成參考型態的 Integer 。
</p>

<pre class="highlight"><code><span class="c1">//revision: 4</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="n">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">N</span> <span class="n">n</span> <span class="o">=</span> <span class="k">new</span> <span class="n">N</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">Cx</span><span class="o">&lt;</span><span class="n">N</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">cn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">N</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;(</span> <span class="n">n</span> <span class="o">);</span>
        <span class="c1">// ^  type parameter N is not within its bound</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">cn</span><span class="o">.</span><span class="na">getData</span><span class="o">()</span> <span class="o">);</span>

        <span class="n">M</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">M</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">Cx</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">cm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">M</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;(</span> <span class="n">m</span> <span class="o">);</span>
        <span class="c1">// ^  type parameter M is not within its bound</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">cm</span><span class="o">.</span><span class="na">getData</span><span class="o">()</span> <span class="o">);</span>

        <span class="n">S</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">S</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
        <span class="n">Cx</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cx</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;(</span> <span class="n">s</span> <span class="o">);</span>
        <span class="c1">// ^  type parameter S is not within its bound</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">cs</span><span class="o">.</span><span class="na">getData</span><span class="o">()</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>


<p>
<q>type parameter ? is not within its bound</q> 又是什麼意思？
</p>

<h4>Revision 5</h4>

<p>
回顧一下 Cx 泛型的內容，我告訴 javac: "參數 DataType 的泛型是 IDataType 介面"。
如此一來就給了一個限制條件，將 <code>DataType</code> 可以接受的類型侷限在實作了 <code>IDataType</code> 的類別。但是類別 N, M, S 並未宣告它們實作了 <code>IDataType</code> 介面，所以不在 <code>DataType</code> 可接受的範圍中。因此我要再修改類別 N, M, S 的內容，加上 <code>IDataType</code> 的宣告。
</p>
<p>
原本這三個類別之間沒有關係，但改寫至此， Java 強迫我們拉上關係，讓這三個類別實現了同一個介面。此非我所願，幸好在這個範例中的影嚮不大。得過且過吧。
</p>

<pre class="highlight"><code><span class="c1">//revision: 5</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">N</span> <span class="kd">implements</span> <span class="n">IDataType</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">n</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">N</span><span class="o">()</span> <span class="o">{</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">N</span><span class="o">(</span><span class="n">Integer</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span> <span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="n">value</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">n</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre>

<br/>

<pre class="highlight"><code><span class="c1">//revision: 5</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">M</span> <span class="kd">implements</span> <span class="n">IDataType</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">m</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">M</span><span class="o">()</span> <span class="o">{</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">M</span><span class="o">(</span><span class="n">Integer</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span> <span class="n">m</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="n">value</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">10</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre>

<br/>

<pre class="highlight"><code><span class="c1">//revision: 5</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">S</span> <span class="kd">implements</span> <span class="n">IDataType</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">s</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">S</span><span class="o">()</span> <span class="o">{</span> <span class="n">s</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">S</span><span class="o">(</span><span class="n">String</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span> <span class="n">s</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="n">value</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre>


<pre class="language-text">
$ javac *.java
$ java Main
-1
10
hello

</pre>

<p>
這次大功告成，我終於如願以償地寫了一個 Java 的泛型類別... 差點忘了還有一個泛型介面。
同時，我也覺得 C++ 樣板沒那麼難了。
</p>
<p>
Java 的泛型語法不改要程序員先跳過火圈才能吃到香蕉的本色，我<em>只跳了兩個圈圈</em>就重構完成這個很單純的範例程式。
不過現實可沒那麼輕鬆，至少在我日前負責的案子中，有幾處地方我就放棄用泛型去重構它們，那簡直是自討苦吃。舉個例子來說，我想在 Cx 泛型中增加一個無參數的預設建構子，如下列:
</p>
<pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cx</span><span class="o">&lt;</span><span class="n">DataType</span> <span class="kd">extends</span> <span class="n">IDataType</span><span class="o">&lt;</span><span class="n">ReturnType</span><span class="o">&gt;,</span> <span class="n">ReturnType</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">DataType</span> <span class="n">data</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Cx</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataType</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Cx</span><span class="o">(</span><span class="n">DataType</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">ReturnType</span> <span class="n">getData</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre>

<p>
我增加了第4~6行的預設建構子，看起來非常簡單、非常合理、不應該受到任何刁難的需求，但是 javac 高舉手中的法杖發出刺目紅光對我大喊: <q>Unexcepted type!</q>。我就是不可以直接 new 一個參數化型別的實例。但是 C++ 樣板可以這麼做，一點都不廢話。
</p>

<p>
反正案子快結了，也沒人關心軟體內部是不是充斥太多重複的程式碼。至少我沒省略測試案例，天天都跑一次 AllTests 和 Nightly build ，交給客戶的軟體外在品質合格，也就夠了。既然 Java 語言並沒有提供靈活的方法讓我們輕鬆地進行重構工作，還是算了吧，早點下班比較實在。
</p>
<h6>相關文章</h6>
<ul>
<li><a href="{{ site.baseurl }}/archives/2009/%E8%88%87%20metavige%20%E5%92%8C%20alexchen%20%E5%B0%8D%E8%A9%B1%20Java%20%E8%AA%9E%E8%A8%80.html">與 metavige 和 alexchen 對話 Java 語言</a></li>
<li><a href="{{ site.baseurl }}/archives/2009/%E4%BB%A5%E4%B8%8D%E5%90%8C%E8%AA%9E%E8%A8%80%E7%9A%84%E8%A7%80%E9%BB%9E%E4%BE%86%E7%9C%8B%20C%2B%2B%20template.html">以不同語言的觀點來看 C++ template</a></li>
</ul>
<div class="note">樂多舊網址: <a href="http://blog.roodo.com/rocksaying/archives/10890551.html">http://blog.roodo.com/rocksaying/archives/10890551.html</a></div>